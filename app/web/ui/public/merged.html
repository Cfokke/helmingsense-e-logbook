<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HelmingSense — Merged Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="stylesheet" href="/css/helming.css">
  <style>
    /* Full-width layout */
    .wrap{max-width:none;margin:0 auto;padding:12px}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .bar h1{margin:0 8px 0 0;font-size:16px}
    .btn{appearance:none;border:1px solid #ccc;background:#f7f7f7;border-radius:6px;padding:6px 10px;cursor:pointer;text-decoration:none;color:inherit}
    .btn:disabled{opacity:.6;cursor:default}
    .muted{color:#666;font-size:12px;margin-left:auto}

    /* Twin-scrollbar pattern */
    .scroller-top{height:14px;overflow-x:auto;overflow-y:hidden;border:1px solid #ddd;border-radius:8px;margin-bottom:6px;background:#fff}
    .scroller-inner{height:1px} /* we just need width */

    .table-wrap{overflow:auto;border:1px solid #ddd;border-radius:10px;background:#fff}
    table{border-collapse:collapse;width:100%;min-width:1100px}
    thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #ddd;padding:8px;text-align:left;font-weight:600}
    tbody td{border-bottom:1px solid #eee;padding:6px 8px;white-space:nowrap}

    /* Row tints */
    tr.row-auto   > td{ background:#eaf6ee }
    tr.row-manual > td{ background:#fbeaea }

    /* Observations second line (wrap, subtle) */
    tr.obs-row td{
      white-space:normal;color:#6b7280;font-size:12px;border-top:0;
      padding-top:4px;padding-bottom:8px;
    }
    tr.obs-row td .label{ font-weight:600; color:#94a3b8; margin-right:6px }
    thead th.compact { padding-top:6px; padding-bottom:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>HelmingSense — Merged Log</h1>
      <a class="btn" href="/data/merged_log_with_type.csv" download>Download CSV</a>
      <label><input id="showAuto"   type="checkbox" checked> Show autologs</label>
      <label><input id="showManual" type="checkbox" checked> Show manuals</label>
      <button id="refreshBtn" class="btn">Refresh</button>
      <a class="btn" href="http://localhost:8090/">Manual Entry</a>
      <span id="meta" class="muted">…</span>
    </div>

    <!-- TOP SCROLLBAR -->
    <div id="topScroll" class="scroller-top"><div id="topInner" class="scroller-inner"></div></div>

    <div id="tblWrap" class="table-wrap">
      <table id="logTbl">
        <thead>
          <tr>
            <th class="compact">Time</th>
            <th class="compact">Position</th>
            <th class="compact">COG/SOG</th>
            <th class="compact">HdgMag/HdgTrue</th>
            <th class="compact">AWS/TWS/TWD</th>
            <th class="compact">Temp/Pres/Hum</th>
            <th class="compact">Pitch/Roll</th>
            <th class="compact">Crew</th>
            <th class="compact">APilot</th>
            <th class="compact">Prop</th>
            <th class="compact">Vis</th>
            <th class="compact">Sea</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:8px">
      Tip: Use the checkboxes to include/exclude Autolog/Manual rows before printing.
    </p>
  </div>

  <script>
    const CSV_URL = '/data/merged_log_with_type.csv';
    const bodyEl  = document.getElementById('logBody');
    const metaEl  = document.getElementById('meta');
    const showAutoEl   = document.getElementById('showAuto');
    const showManualEl = document.getElementById('showManual');
    const refreshBtn   = document.getElementById('refreshBtn');

    const wrapEl = document.getElementById('tblWrap');
    const topScroll = document.getElementById('topScroll');
    const topInner  = document.getElementById('topInner');

    refreshBtn.addEventListener('click', load);
    showAutoEl.addEventListener('change', render);
    showManualEl.addEventListener('change', render);

    // sync horizontal scroll both ways
    topScroll.addEventListener('scroll', () => { wrapEl.scrollLeft = topScroll.scrollLeft; });
    wrapEl.addEventListener('scroll', () => { topScroll.scrollLeft = wrapEl.scrollLeft; });

    let rows = [];

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift().replace(/^\uFEFF/,'');
      const cols = splitCSVLine(header);
      return lines.map(line => {
        const cells = splitCSVLine(line);
        const rec = {};
        cols.forEach((k, i) => rec[k.replace(/^"|"$/g,'')] = (cells[i] ?? '').replace(/^"|"$/g,''));
        return rec;
      });
    }
    function splitCSVLine(line){
      const out=[], re=/("([^"]|"")*"|[^,]*)(,|$)/g; let m;
      while ((m = re.exec(line)) !== null){ out.push(m[1]); if(m[3] === '') break; }
      return out;
    }

    function load(){
      fetch(CSV_URL, {cache:'no-store'})
        .then(r => r.text())
        .then(txt => {
          rows = parseCSV(txt);
          metaEl.textContent = `Loaded ${rows.length} rows • ${new Date().toUTCString()}`;
          render();
          // after render, size the top scroller to match table width
          requestAnimationFrame(() => {
            const tbl = document.getElementById('logTbl');
            topInner.style.width = tbl.scrollWidth + 'px';
          });
        })
        .catch(err => { metaEl.textContent = 'Failed to load'; console.error(err); });
    }

    function render(){
      const showAuto   = showAutoEl.checked;
      const showManual = showManualEl.checked;
      bodyEl.innerHTML = '';

      const MAIN_COLS = ["Time","Position","COG/SOG","HdgMag/HdgTrue","AWS/TWS/TWD","Temp/Pres/Hum","Pitch/Roll","Crew","APilot","Prop","Vis","Sea"];

      rows.forEach(r => {
        const type = (r.Type || '').toLowerCase();
        if ((type === 'auto' && !showAuto) || (type === 'manual' && !showManual)) return;

        const tr = document.createElement('tr');
        tr.className = type === 'manual' ? 'row-manual' : 'row-auto';
        MAIN_COLS.forEach(k => {
          const td = document.createElement('td');
          td.textContent = r[k] || '';
          tr.appendChild(td);
        });
        bodyEl.appendChild(tr);

        const obs = (r.Observations || '').trim();
        if (obs){
          const trObs = document.createElement('tr');
          trObs.className = 'obs-row';
          const td = document.createElement('td');
          td.colSpan = MAIN_COLS.length;
          td.innerHTML = `<span class="label">OBS:</span>${escapeHtml(obs)}`;
          trObs.appendChild(td);
          bodyEl.appendChild(trObs);
        }
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    load();
  </script>
</body>
</html>
