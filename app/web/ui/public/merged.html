<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HelmingSense — Merged Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/favicon.png">

  <!-- Shared nautical theme -->
  <link rel="stylesheet" href="/css/helming.css?v=3">

  <style>
    /* Local bits (most styling via helming.css) */
    :root{
      --bg-auto:#eaf6ee; /* light green */
      --bg-man:#fbeaea;  /* light red   */
      --border:#ddd; --head:#fafafa; --muted:#666;
    }
    body{margin:0}
    header{position:sticky;top:0;background:var(--head);border-bottom:1px solid var(--border);padding:10px;z-index:20}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{margin:0 8px 0 0;font-size:16px}
    .btn{appearance:none;border:1px solid #ccc;background:#f7f7f7;border-radius:6px;padding:6px 10px;cursor:pointer;text-decoration:none;color:inherit}
    .btn:disabled{opacity:.6;cursor:default}
    .muted{margin-left:auto;color:var(--muted);font-size:12px}
    main{padding:12px}

    /* Top + bottom horizontal scrollers (synced) */
    .scroller {
      overflow-x: auto;
      overflow-y: hidden;
      height: 16px;             /* just a scrollbar track */
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      margin-bottom: 8px;
    }
    .scroller-inner { height: 1px; } /* we set width via JS to table scrollWidth */

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px;background:#fff}
    table{border-collapse:collapse;width:100%;min-width:1100px;background:#fff}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:8px;text-align:left}
    tbody td{border-bottom:1px solid #eee;padding:6px 8px;white-space:nowrap}

    tr.auto   { background: var(--bg-auto); }
    tr.manual { background: var(--bg-man); }

    .tip{color:var(--muted);font-size:12px;margin:8px 0}
    .spacer{flex:1}

    @media print {
      .scroller { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>HelmingSense — Merged Log</h1>

      <label><input id="f-auto"   type="checkbox" checked> Show autologs</label>
      <label><input id="f-manual" type="checkbox" checked> Show manuals</label>

      <button id="btn-refresh" class="btn">Refresh</button>
      <a id="btn-download" class="btn" href="/data/merged_log_with_type.csv" download>Download CSV</a>
      <button id="btn-print" class="btn" onclick="window.print()">Print</button>

      <span class="spacer"></span>

      <a class="btn" href="http://localhost:8090/" target="_blank" rel="noopener">Manual Entry</a>
      <span id="loaded" class="muted"></span>
    </div>
  </header>

  <main>
    <!-- NEW: Top scrollbar synced with table below -->
    <div id="scrollTop" class="scroller">
      <div id="scrollTopInner" class="scroller-inner"></div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="grid">
        <thead>
          <tr id="thead-row"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p class="tip">Tip: Use the checkboxes to include/exclude Autolog/Manual rows before printing.</p>
  </main>

  <script>
  (function(){
    const CSV_URL   = '/data/merged_log_with_type.csv';
    const tbody     = document.getElementById('tbody');
    const theadRow  = document.getElementById('thead-row');
    const loaded    = document.getElementById('loaded');
    const fAuto     = document.getElementById('f-auto');
    const fManual   = document.getElementById('f-manual');
    const btnRefresh= document.getElementById('btn-refresh');

    const wrap      = document.getElementById('tableWrap');
    const grid      = document.getElementById('grid');
    const scrollTop = document.getElementById('scrollTop');
    const scrollTopInner = document.getElementById('scrollTopInner');

    // CSV parser (quoted fields supported)
    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inQ=false;
      while(i<text.length){
        const c=text[i++];
        if(inQ){
          if(c==='\"'){
            if(text[i]==='\"'){ field+='"'; i++; }
            else inQ=false;
          } else field+=c;
        }else{
          if(c==='\"'){ inQ=true; }
          else if(c===','){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); field=''; row=[]; }
          else if(c!=='\r'){ field+=c; }
        }
      }
      if(field!=='' || row.length){ row.push(field); rows.push(row); }
      return rows;
    }

    function render(rows){
      if(!rows || rows.length===0){ tbody.innerHTML=''; theadRow.innerHTML=''; return; }
      const header = rows[0];
      const data   = rows.slice(1);

      // Rebuild header (respect CSV order)
      theadRow.innerHTML = header.map(h=>`<th>${escapeHtml(h)}</th>`).join('');

      const idxType = header.findIndex(h => h.toLowerCase()==='type');

      // Build body
      const cells = data.map(cols=>{
        const type = (idxType>=0 ? (cols[idxType]||'').toLowerCase() : '');
        const cls  = type.startsWith('aut') ? 'auto' : (type.startsWith('man') ? 'manual' : '');
        const tds  = cols.map(v=>`<td>${escapeHtml(v)}</td>`).join('');
        return `<tr class="${cls}">${tds}</tr>`;
      }).join('');
      tbody.innerHTML = cells;

      applyFilters();
      loaded.textContent = `loaded ${data.length} rows — ${new Date().toUTCString()}`;

      // After render, size the top scroller to the table width
      syncTopScrollerWidth();
    }

    function applyFilters(){
      const showA = fAuto.checked;
      const showM = fManual.checked;
      for(const tr of tbody.querySelectorAll('tr')){
        const isA = tr.classList.contains('auto');
        const isM = tr.classList.contains('manual');
        tr.style.display = (isA && !showA) || (isM && !showM) ? 'none' : '';
      }
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    async function load(){
      try{
        const res = await fetch(CSV_URL + '?t=' + Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error('failed to load');
        const txt = await res.text();
        render(parseCSV(txt));
      }catch(e){
        loaded.textContent = 'failed to load';
        tbody.innerHTML = '';
      }
    }

    // Top/bottom scrollbar sync
    let syncing = false;
    function syncScroll(fromTop){
      if(syncing) return;
      syncing = true;
      if(fromTop){
        wrap.scrollLeft = scrollTop.scrollLeft;
      }else{
        scrollTop.scrollLeft = wrap.scrollLeft;
      }
      syncing = false;
    }
    function syncTopScrollerWidth(){
      // Make the top scroller's inner width match the table's scrollWidth
      const w = grid.scrollWidth;
      scrollTopInner.style.width = w + 'px';
      // Keep positions aligned
      scrollTop.scrollLeft = wrap.scrollLeft;
    }

    // Event wiring
    fAuto.addEventListener('change', applyFilters);
    fManual.addEventListener('change', applyFilters);
    btnRefresh.addEventListener('click', load);
    wrap.addEventListener('scroll', ()=>syncScroll(false));
    scrollTop.addEventListener('scroll', ()=>syncScroll(true));
    window.addEventListener('resize', syncTopScrollerWidth);

    // Initial load + periodic refresh
    load();
    setInterval(load, 60000);
  })();
  </script>
</body>
</html>
